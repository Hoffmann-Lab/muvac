### INFO
muvac is a fully multithreaded pipeline to call, merge and annotate germline or somatic variants
- from mappings in BAM format
- or from RAW sequencing WG/exon/RNA experiments in FastQ format either Phred33 or Phred64 encoded (uncompressed, gzip or bzip2),
- trimmed using Trimmomatic,
- corrected using Rcorrector for germline variant screening,
- mapped by Segemehl, TopHat2, BWA, STAR
- using callers Freebayes, HaplotypeCaller, MuTect2, Samtools/Bcftools, Platypus, Samtools/VarScan, VarDict, LoFreq, deepSNV
-> splitting multiallic hits and unifying vcf formats
- and using annotation tools Annovar, SnpEff

### INSTALLATION
1) you need to be root to install dependencies, unless already present (to check this go on with step 2)
sudo apt-get update
sudo apt-get install cmake git g++ gcc make python-dev automake curl
2) create a shell variable MUVAC assigned to an installation directory
export MUVAC=/path/to/install/dir
3) store the MUVAC variable permanently to ensure that muvac can always find the required tools
echo "export MUVAC=$MUVAC" >> ~/.bashrc
4) download the latest muvac release from https://github.com/koriege/muvac
git clone --recursive https://github.com/koriege/muvac.git
5) enter the muvac directory 
cd muvac
6) checkout latest stable release
git checkout $(git describe --tags)
7) install all tools for variant calling
./setup -i all
8) (optional) install variant annotation tools for hg19
./setup -i anno [-t <number>] [-annovar <url>]
- use '-t <number>' option to run compiler and databse indexing on <number> cpu cores (default: all)
- use '-annovar <url>' as optional option to install Annovar 
- get Annovar download url from http://annovar.openbioinformatics.org/

### UPGRADE
1) follow the INSTALLATION steps 4 to 6
./setup -i upgrade

### DOWNLOAD HG19/GRCh37.p13 or HG38/GRCh38.p7 or MM10/GRCm38.p6 and corresponding dbSNP vcf
./dlgenome -g [hg19|hg38|mm10] -o /path/to/genome/dir

### FIRST RUN INFO
- genomes will be indexed for selected mappers
=> do not run multiple muvac instances in parallel unless indexes are created
- in case indexes are already present 
=> copy $MUVAC/bin/muvac/lib/md5s to <genome.fa>.md5s and insert values returned by the command 'md5sum <file>'

### RUN
- make sure to have your genome and dbSNP vcf file in the same directory
- make sure your genome file ends with '.fa' and your dbSNP file ends with '.fa.vcf'
- make sure the file name prefixes of your genome and dbSNP file are equal (e.g. hg19.fa and hg19.fa.vcf)
- make sure the fasta headers in your genome are named and sorted this way '>chrM' '>chr1' ... '>chr22' '>chrX' '>chrY'
=> following the DOWNLOAD instructions  will do this for you

1) calling for help?
$MUVAC/bin/muvac/muvac -h
$MUVAC/bin/muvac/muvac-somatic -h

2) adapt and use one of the terminal commands below
$MUVAC/bin/muvac/muvac -1 R1.fq -2 R2.fq -g genomes/hg19.fa -o results -l results/run.log
$MUVAC/bin/muvac/muvac -m 1.bam -g genomes/hg19.fa -o results -l results/run.log
$MUVAC/bin/muvac/muvac-somatic -n1 normalR1.fq -n2 normalR2.fq -t1 tumorR1.fq -t2 tumorR2.fq -g genomes/hg19.fa -o results -l results/run.log
$MUVAC/bin/muvac/muvac-somatic -nm normal.bam -tm tumor.bam -g genomes/hg19.fa -o results -l results/run.log

- for RNA-Seq data use the '-split' option
$MUVAC/bin/muvac/muvac -1 R1.fq -2 R2.fq -split -g genomes/hg19.fa -o results -l results/run.log

- for multiple experiments, concatenate inputs using ','
$MUVAC/muvac -1 patient1_1.fq,patient2_1.fq -2 patient1_2.fq,patient2_2.fq -g genomes/hg19.fa -o results -l results/run.log

3) if no adapter clipping is necessary just call muvac this way
(echo 'n') | $MUVAC/bin/muvac/muvac [options]
(echo 'n') | $MUVAC/bin/muvac/muvac-somatic [options]

### LOGS and verbosity
- a comprehensive log file 'run.log' file will be created in your output directory, unless defined otherwise
- using the verbose option '-v' will additionally print full log to terminals stdout

### RUN IN BACKGROUND
1) start a screen with a unique name
screen -S myMUVACrun
2) run muvac
3) detach the screen by pressing all 3 keys 'ctrl+a+d'
4) list screens running in background
screen -ls
4) resume a screen 
screen -r myMUVACrun

### RESULTS
- results can be found in the vcf/(segemehl|tophat|bwa|star) directories
- merged multi-caller germline variants are named *.merged.vcf and can be visualized e.g. using Varvis
- germline variant annotations can be found in the annotation/(segemehl|tophat|bwa|star)/(annovar|snpeff) directories

### INFO: RESULTS
- bcftools-norm is used to split multiallelic report into single reports with related genotype (GT) and genotype quality (GQ)
=> muvac returns the best variants according to highest GQ (re-computed from PL or GL) or minor allele frequency (MAF)
- vcfsamplediff is used to extract somatic variants from FreeBayes and Platypus outputs

### INFO: GERMLINE ANNOTATION RESULTS
1) Annovar (see http://annovar.openbioinformatics.org/en/latest/user-guide/download)
- gene annotations (refSeq) are named 
  *.variant_function and *.exonic_variant_function
- region annotations (TFBS, miRNA/snoRNA, miRNA-BS, GWAS) are named 
  *.hg19_(tfbsConsSites|wgRna|targetScanS|gwasCatalog) 
- filtered annotations (NHLBI-ESP, 1000 Genomes, ExAC, dbSNP, NSFP, ClinVar) are named 
  *.hg19_(esp6500siv2_all|1000g2015aug_all|exac03|avsnp147|dbnsfp33a|clinvar_20170130)_dropped
- merged annotations are named *.hg19_multianno.vcf
2) SnpEff (see http://snpeff.sourceforge.net/SnpSift.html)
- gene annotations (Ensembl, TFBS, Nextprot) are named *.annotated.vcf
- region annotations (Ensembl promoter, Ensembl miRNA TSS) are named *.(promoter|miRNApromoter).vcf
- filtered annotations (ExAC, dbSNP, NSFP, ClinVar) are named *.(exac|dbsnp|dbnsfp|clinvar).vcf

### INTERMEDIATE RESULTS (in processing order)
- qualities directory: raw read quality statistics by FastQC
- converted directory: phred64 to phred33 quality converted raw reads by fastx_toolkit
- trimmed directory: quality trimmed reads by Trimmomatic
- corrected directory: error corrected reads by Rcorrector
- mapped/(segemehl|tophat|bwa|star) directory: mapping data *.bam of Segemehl|TopHat2|BWA
- mapped/(segemehl|tophat|bwa|star) directory: realigned (GATK) and reaclibrated mapping data *.bam by GATK or LoFreq

### GENERAL CALLER PARAMETER
if adjustable, all callers are constrained by
min reads DP >= 10
germline allele frequency >= 0.1
somatic allele frequency >= 0.1
alternative alleles <= 3
min base quality >= 20
max variances = all
downsampling = off
expected alleles <=3

### ISSUES and TODOs
- LoFreq and deepSNV resuls will be unprocessed and are excluded from annotation, unification and condensation

### REFERENCES
(c) Konstantin Riege
konstantin{a}bioinf{.}uni-leipzig{.}de
konstantin.riege{a}leibniz-fli{.}de

In case of troubles, don't hesitate to contact me
